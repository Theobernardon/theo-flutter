name: Test et Analyse Flutter Workflow Réutilisable

on:
  workflow_call:
    # Map the workflow outputs to job outputs
    inputs:
      matrix-builds-support:
        required: true
        type: matrix
    outputs:
      description: "Résultat de l'analyse"
        value: ${{ jobs.Builds.outputs.analyse }}
      test_output:
        description: "Résultat des tests"
        value: ${{ jobs.Builds.outputs.test }}

jobs:
  Builds:
    strategy:
      matrix:
        builds-support: ${{ jobs.Builds.outputs.analyse }}

  
    steps:
      # 1️⃣ - Cloner ton code source
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ - Installer Flutter 3.29.2 précisément, avec cache automatique
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.2
          cache: true  # Active le cache pub + flutter automatiquement

      # 3️⃣ - Récupérer les dépendances Dart/Flutter
      - name: Install dependencies
        run: flutter pub get

      # 4️⃣ - Builder ton application Windows
      - name: Build for Windows
        if: matrix.os == 'windows-latest'
        run: flutter build windows

      # 5️⃣ - Archiver les artefacts de la build Windows
      - name: Archive Windows build artifacts
        if: matrix.os == 'windows-latest' && success()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build-windows
          path: build\windows\x64\runner\Release\

      # 4️⃣ - Installer les dépendances nécessaires pour Linux
      - name: Installer les dépendances Linux
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libgtk-3-dev libglib2.0-dev

      # 5️⃣ - Builder ton application Linux
      - name: Build for Linux
        if: matrix.os == 'ubuntu-latest'
        run: flutter build linux

      # 6️⃣ - Archiver les artefacts de la build Linux
      - name: Archive Linux build artifacts
        if: matrix.os == 'ubuntu-latest' && success()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build-linux
          path: build/linux/x64/release/bundle/
