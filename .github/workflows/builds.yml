name: Builder Flutter Workflow R√©utilisable

permissions:
  contents: read

on:
  workflow_call:
    # Map the workflow outputs to job outputs
    inputs:
      platforms:
        required: true
        type: string
        description: 'Liste des plateformes √† builder (ex: ''["linux", "windows"]'')'
      mode:
        required: true
        type: string
        description: "release ou debug"
      retention-days:
        required: false
        type: number
        default: 3 # Par d√©faut, les artefacts debug sont gard√©s 3 jours
        description: "Nombre de jours de conservation des artefacts"
    secrets:
      KEYSTORE_BASE64:
        required: false
        description: "Keystore Android encod√© en base64 (requis pour APK release)"
      KEYSTORE_PASSWORD:
        required: false
        description: "Mot de passe du keystore"
      KEY_ALIAS:
        required: false
        description: "Alias de la cl√©"
      KEY_PASSWORD:
        required: false
        description: "Mot de passe de la cl√©"

jobs:
  matrix:
    strategy:
      matrix:
        platform: ${{ fromJson(inputs.platforms) }} # '["linux", "windows", "macos", "apk", "appbundle", "ios", "web"]'
        os: [ubuntu-latest, windows-latest, macos-latest]
        # Exclusions des plateformes pour chaque OS
        exclude:
          # Exclusions des windows:
          - platform: linux #    Table des exclusions pour les plateformes
            os: windows-latest #        O --> valid | X --> excluded
          - platform: macos #    |        |linux|windows|macos|ios|web|apk|appbundle
            os: windows-latest # |linux   |  O  |   X   |  X  | X | O | O |    O
          - platform: ios #      |windows |  X  |   O   |  X  | X | X | X |    X
            os: windows-latest # |macos   |  X  |   X   |  O  | O | X | X |    X
          - platform: web
            os: windows-latest
          - platform: apk
            os: windows-latest
          - platform: appbundle
            os: windows-latest
          # Exclusions des macos:
          - platform: linux
            os: macos-latest
          - platform: windows
            os: macos-latest
          - platform: web
            os: macos-latest
          - platform: apk
            os: macos-latest
          - platform: appbundle
            os: macos-latest
          # Exclusions des linux:
          - platform: windows
            os: ubuntu-latest
          - platform: macos
            os: ubuntu-latest
          - platform: ios
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.platform }} (${{ inputs.mode }})
    steps:
      #### Partie 1 : Pr√©paration ####
      - name: 1Ô∏è‚É£ - Cloner ton code source
        uses: actions/checkout@v4

      - name: 2Ô∏è‚É£ - Actions de formatage pour ${{ matrix.platform }} (${{ inputs.mode }})
        uses: Theobernardon/theo-flutter/.github/actions/pre-steps-spe-platform@main
        with:
          platform: ${{ matrix.platform }}
          mode: ${{ inputs.mode }}

      - name: 3Ô∏è‚É£ - Installer Flutter avec pubspec.yaml, et cache automatique
        uses: subosito/flutter-action@v2
        with:
          channel: stable # Utilise le canal stable pour la version de Flutter
          flutter-version-file: pubspec.yaml
          cache: true # Active le cache pub + flutter automatiquement

      - name: 4Ô∏è‚É£ - Installer les d√©pendances flutter
        run: flutter pub get

      - name: 5Ô∏è‚É£ - Cr√©ation des ic√¥nes
        run: dart run flutter_launcher_icons

      # üîê NOUVELLE √âTAPE : Signature APK (seulement pour APK en mode release)
      - name: pre6Ô∏è‚É£ - V√©rifier la disponibilit√© de la signature personnalis√©e
        if: ${{ (matrix.platform == 'apk' || matrix.platform == 'appbundle') && inputs.mode == 'release' }}
        id: check-signing
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -n "${KEYSTORE_BASE64}" ]; then
            echo "‚úÖ Signature personnalis√©e d√©tect√©e - Utilisation du keystore fourni"
            echo "has-custom-signing=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Aucune signature personnalis√©e - Utilisation de la signature par d√©faut (debug keystore)"
            echo "‚ÑπÔ∏è Pour une vraie release production, configurez les secrets : KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD"
            echo "has-custom-signing=false" >> $GITHUB_OUTPUT
          fi

      - name: pre6Ô∏è‚É£bis - Configuration de la signature personnalis√©e
        if: ${{ (matrix.platform == 'apk' || matrix.platform == 'appbundle') && inputs.mode == 'release' && steps.check-signing.outputs.has-custom-signing == 'true' }}
        uses: Theobernardon/theo-flutter/.github/actions/setup-sing@main
        with:
          keystore_base64: ${{ secrets.KEYSTORE_BASE64 }}
          keystore_password: ${{ secrets.KEYSTORE_PASSWORD }}
          key_alias: ${{ secrets.KEY_ALIAS }}
          key_password: ${{ secrets.KEY_PASSWORD }}

      - name: 6Ô∏è‚É£ - Build pour ${{ matrix.platform }} (${{ inputs.mode }})
        id: build
        uses: Theobernardon/theo-flutter/.github/actions/flutter-build@main
        with:
          platform: ${{ matrix.platform }}
          mode: ${{ inputs.mode }}

      #### Partie 2 : Archiver les artefacts ####
      - name: 7Ô∏è‚É£ - Archive ${{ matrix.platform }} build artifacts (debug only)
        if: ${{ success() && inputs.mode == 'debug' }}
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build-${{ matrix.platform }}
          path: ${{ steps.build.outputs.parent-dir }} # Chemin du dossier parent du build
          retention-days: ${{ inputs.retention-days }}

      - name: 7Ô∏è‚É£ - Archive ${{ matrix.platform }} build artifacts (release only)
        if: ${{ success() && inputs.mode == 'release' }}
        uses: Theobernardon/theo-flutter/.github/actions/package-builds-release@main
        with:
          platform: ${{ matrix.platform }}
          path: ${{ steps.build.outputs.parent-dir }} # Chemin du dossier parent du build
