name: 🛠️ Build Flutter App

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: "Liste des plateformes cibles (ex: android,web,ios)"
        required: true
        default: "android,web"
  push:
    branches:
      - develop
      - release/**
      - main

jobs:
  build:
    name: 🔧 Build Matrix
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.generate-matrix.outputs.platforms }}

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🧮 Générer la matrice de build
        id: generate-matrix
        run: |
          platforms="${{ github.event.inputs.platforms || 'android,web,windows,macos,ios' }}"
          matrix=$(echo "$platforms" | awk -F',' '{ printf "{\"include\":[\"; for (i=1; i<=NF; i++) { printf "{\"platform\":\"%s\"}%s", $i, (i<NF ? "," : "") } printf "]}" }')
          echo "platforms=$matrix" >> $GITHUB_OUTPUT

  build-platform:
    name: "📦 Build ${{ matrix.platform }}"
    needs: build
    strategy:
      matrix: ${{ fromJson(needs.build.outputs.matrix) }}

    runs-on: |
      ${{
        matrix.platform == 'windows' && 'windows-latest' ||
        (matrix.platform == 'macos' || matrix.platform == 'ios') && 'macos-latest' ||
        'ubuntu-latest'
      }}

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ⚙️ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "stable"

      - name: 🔧 Flutter pub get
        run: flutter pub get

      - name: 🛠️ Build ${{ matrix.platform }}
        run: |
          case ${{ matrix.platform }} in
            android)
              flutter build apk
              ;;
            web)
              flutter build web
              zip -r build/web.zip build/web
              ;;
            windows)
              flutter build windows
              ;;
            linux)
              flutter build linux
              ;;
            macos)
              flutter build macos
              ;;
            ios)
              flutter build ios
              ;;
          esac

      - name: 📤 Upload artifact ${{ matrix.platform }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            build/**/outputs/**/*.apk
            build/web.zip
            build/windows/**/Release/*.exe
            build/linux/**/release/*
            build/macos/Build/**/*.app
            build/ios/iphoneos/*.app
            build/ios/ipa/*.ipa
