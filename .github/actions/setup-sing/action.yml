name: Sign Android APK
description: "Signe l'APK Android avec le keystore fourni via les secrets GitHub"
inputs:
  keystore_base64:
    description: "Keystore encodÃ© en base64"
    required: true
  keystore_password:
    description: "Mot de passe du keystore"
    required: true
  key_alias:
    description: "Alias de la clÃ©"
    required: true
  key_password:
    description: "Mot de passe de la clÃ©"
    required: true
runs:
  using: composite
  steps:
    - name: Enregistrer le nettoyage post-job
      uses: gacts/run-and-post-run@v1
      with:
        run: echo "ðŸ“ Nettoyage post-job enregistrÃ©"
        post: |
          rm -f android/app/upload-keystore.jks
          rm -f android/key.properties
          echo "ðŸ§¹ Fichiers sensibles supprimÃ©s (post-job)"

    - name: CrÃ©er le dossier de configuration Android
      shell: bash
      run: mkdir -p android/app/

    - name: DÃ©coder et crÃ©er le keystore
      shell: bash
      env:
        KEYSTORE_BASE64: ${{ inputs.keystore_base64 }}
      run: |
        echo "${KEYSTORE_BASE64}" | base64 --decode > android/app/upload-keystore.jks
        # VÃ©rifier que le fichier a Ã©tÃ© crÃ©Ã©
        if [ ! -f android/app/upload-keystore.jks ]; then
          echo "âŒ Erreur : Le keystore n'a pas Ã©tÃ© crÃ©Ã©"
          exit 1
        fi
        echo "âœ… Keystore crÃ©Ã© avec succÃ¨s"

    - name: CrÃ©er le fichier key.properties
      shell: bash
      env:
        KEYSTORE_PASSWORD: ${{ inputs.keystore_password }}
        KEY_PASSWORD: ${{ inputs.key_password }}
        KEY_ALIAS: ${{ inputs.key_alias }}
      run: |
        cat > android/key.properties << EOF
        storePassword=${KEYSTORE_PASSWORD}
        keyPassword=${KEY_PASSWORD}
        keyAlias=${KEY_ALIAS}
        storeFile=upload-keystore.jks
        EOF
        echo "âœ… Fichier key.properties crÃ©Ã©"
