name: Sign Android APK
description: "Signe l'APK Android avec le keystore fourni via les secrets GitHub"
inputs:
  keystore_base64:
    description: "Keystore encodÃ© en base64"
    required: true
  keystore_password:
    description: "Mot de passe du keystore"
    required: true
  key_alias:
    description: "Alias de la clÃ©"
    required: true
  key_password: 
    description: "Mot de passe de la clÃ©"
    required: true
runs:
  using: composite
  steps:
    - name: CrÃ©er le dossier de configuration Android
      shell: bash
      run: mkdir -p android/

    - name: DÃ©coder et crÃ©er le keystore
      shell: bash
      env:
        KEYSTORE_BASE64: ${{ inputs.keystore_base64 }}
      run: |
        echo "${KEYSTORE_BASE64}" | base64 --decode > android/upload-keystore.jks
        # VÃ©rifier que le fichier a Ã©tÃ© crÃ©Ã©
        if [ ! -f android/upload-keystore.jks ]; then
          echo "âŒ Erreur : Le keystore n'a pas Ã©tÃ© crÃ©Ã©"
          exit 1
        fi
        echo "âœ… Keystore crÃ©Ã© avec succÃ¨s"

    - name: CrÃ©er le fichier key.properties
      shell: bash
      env:
        KEYSTORE_PASSWORD: ${{ inputs.keystore_password }}
        KEY_PASSWORD: ${{ inputs.key_password }}
        KEY_ALIAS: ${{ inputs.key_alias }}
      run: |
        cat > android/key.properties << EOF
        storePassword=${KEYSTORE_PASSWORD}
        keyPassword=${KEY_PASSWORD}
        keyAlias=${KEY_ALIAS}
        storeFile=upload-keystore.jks
        EOF
        echo "âœ… Fichier key.properties crÃ©Ã©"

    - name: Configurer build.gradle pour la signature
      shell: bash
      run: |
        # Backup du fichier original
        cp android/app/build.gradle android/app/build.gradle.backup
        
        # VÃ©rifier si la configuration de signature existe dÃ©jÃ 
        if ! grep -q "signingConfigs" android/app/build.gradle; then
          echo "ðŸ“ Ajout de la configuration de signature"
          
          # InsÃ©rer la configuration de signature (compatible Linux et macOS avec Perl)
          perl -i -pe 's/(android \{)/\1\n    def keystoreProperties = new Properties()\n    def keystorePropertiesFile = rootProject.file("key.properties")\n    if (keystorePropertiesFile.exists()) {\n        keystoreProperties.load(new FileInputStream(keystorePropertiesFile))\n    }\n\n    signingConfigs {\n        release {\n            keyAlias keystoreProperties["keyAlias"]\n            keyPassword keystoreProperties["keyPassword"]\n            storeFile file(keystoreProperties["storeFile"])\n            storePassword keystoreProperties["storePassword"]\n        }\n    }/' android/app/build.gradle
          
          # Ajouter signingConfig dans buildTypes
          perl -i -pe 's/(buildTypes \{.*?release \{)/\1\n            signingConfig signingConfigs.release/s' android/app/build.gradle
          
          echo "âœ… Configuration de signature ajoutÃ©e"
        else
          echo "â„¹ï¸ Configuration de signature dÃ©jÃ  prÃ©sente"
        fi

    - name: Nettoyer les fichiers sensibles
      if: always()
      shell: bash
      run: |
        rm -f android/upload-keystore.jks
        rm -f android/key.properties
        rm -f android/app/build.gradle.backup
        echo "ðŸ§¹ Fichiers sensibles supprimÃ©s"